---
title: "monitoring aid analysis"
author: "Connor"
date: "4/11/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(plotly)
library(readxl)
library(janitor)
options(scipen = 99)
```


Read in Data from 'Monitoring global development aid with machine learning'
- Activity Clusters describes 
  - Year
  - Country
  - Disbursement
  - Sector
  - Sum of Disbursement 


```{r}
activity_clusters <- read_csv(here("data/activity_cluster_data.csv"))
```

Read in Data from 'Monitoring global development aid with machine learning'
  - Descriptive Stats describes
    - Cluster #
    - Topic
    - Area (Believed to be the same as Sector listed above)
    - Sum Disbursement
    - Count Activities


```{r}
descriptive_stats <- read_excel(here("data/descriptive_statistics_clusters.xlsx"))
```

Multiply disbursement by 1 million *needs checking


```{r}
activity_clusters <- activity_clusters %>% 
  mutate(disbursement = USD_Disbursement * 1000000)
```


Group by country and sum the disbursement


```{r}
total_disbursments_by_country <- activity_clusters %>% 
  group_by(RecipientName) %>% 
  summarise(disbursement = sum(disbursement))
```


Group by country and sector and sum the disbursement

```{r}
total_disbursments_by_country_sector <-activity_clusters %>% 
  group_by(RecipientName, Sector) %>% 
  summarise(disbursement = sum(disbursement))
```

Identify all countries in the dataset (184)

```{r}
unique(activity_clusters$RecipientName)
```

Compile list of Small Island Developing States - SIDS 

```{r}
sids <- c('Anguilla', 'Antigua and Barbuda', 'Bahrain', 'Barbados', 'Belize', 'Cabo Verde', 'Comoros', 
             'Cook Islands', 'Dominica', 'Dominican Republic', 'Fiji', 'Grenada', 'Guinea-Bissau', 'Guyana', 
             'Haiti', 'Jamaica', 'Kiribati', 'Maldives', 'Marshall Islands', 'Mauritius', 'Micronesia', 
             'Montserrat', 'Nauru', 'Niue', 'Palau', 'Papua New Guinea', 'Saint Kitts and Nevis', 'Saint Lucia', 
             'Saint Vincent and the Grenadines', 'Samoa', 'Sao Tome and Principe', 'Seychelles', 'Solomon Islands', 
             'Suriname', 'Timor-Leste', 'Tokelau', 'Tonga', 'Trinidad and Tobago', 'Turks and Caicos Islands', 
             'Tuvalu', 'Vanuatu')
```

Filter dataset for only SIDS


```{r}
activity_clusters_sids <- activity_clusters %>%
  filter(RecipientName %in% sids)
```

Identify SIDS in datset (41)

```{r}
unique(activity_clusters_sids$RecipientName)
```

Group by SIDS and sum disbursement

```{r}
total_disbursments_by_sids <- activity_clusters_sids %>% 
  group_by(RecipientName) %>% 
  summarise(disbursement = sum(disbursement))
```

Group by SIDS and sector and sum disbursement

```{r}
total_disbursments_by_sids_sector <- activity_clusters_sids %>% 
  group_by(RecipientName, Sector) %>% 
  summarise(disbursement = sum(disbursement))
```

Plot 

```{r}
plot <- ggplot(total_disbursments_by_sids_sector, aes(x = disbursement,
                                              y = reorder(RecipientName, disbursement),
                                              fill = Sector)) +
  geom_bar(stat = "identity") +
  theme_minimal()

plot
```
Plot Interactively

```{r}
ggplotly(plot)
```


Calculate what percentage of each SIDS budget goes to each sector

```{r}
total_disbursments_by_sids_sector <- total_disbursments_by_sids_sector %>% 
  group_by(RecipientName)  %>% 
  mutate(percentage = disbursement/sum(disbursement))

```

Plot

```{r}
tile_plot <- ggplot(total_disbursments_by_sids_sector, aes(x=Sector , y= RecipientName,
                                              fill = percentage)) +
  geom_tile() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, size = 4, hjust = 1),
        axis.text.y = element_text(size = 3, hjust = 1)) +
  scale_fill_gradient(low = "khaki", high = "red")
  
tile_plot

```
Plot Interactively


```{r}
ggplotly(tile_plot)
```

Calculate what percentage of each countries budget goes to each sector

```{r}
total_disbursments_by_country_sector <- total_disbursments_by_country_sector %>% 
  group_by(RecipientName)  %>% 
  mutate(percentage = disbursement/sum(disbursement))
```

## Join Data

Change cluster name for joining

```{r}
colnames(activity_clusters)[colnames(activity_clusters) == "cluster"] ="Cluster"
```

Join Activity Cluster and Descriptive Stats by Cluster column (cluster = topic)

```{r}
activity_stats_join<- full_join(activity_clusters, descriptive_stats, by='Cluster')
```


Filter joined dataset for SIDS

```{r}
activity_stats_sids<-activity_stats_join %>%
  filter(RecipientName %in% sids)
```


Get unique disbursement for each country and topic

```{r}
activity_stats_sids_clusters<- activity_stats_sids %>% 
  group_by(Cluster, RecipientName, Topic, Sector) %>%
  summarize(sum_disbursment_by_cluster=sum(disbursement))
```



Calculate the topics percentage of each SIDS total disbursement

```{r}
activity_stats_sids_clusters<-activity_stats_sids_clusters %>% 
  group_by(RecipientName)  %>% 
  mutate(percentage = sum_disbursment_by_cluster/sum(sum_disbursment_by_cluster))
```







```{r}
activity_stats_sids <- activity_stats_sids %>% 
  group_by(RecipientName)  %>% 
  mutate(percentage = disbursement/sum(disbursement))
```

```{r}
activity_stats_sids <- activity_stats_sids %>% 
  clean_names()
```


```{r}
topic_sector<- activity_stats_sids %>% 
  group_by(topic, sector) %>% 
  summarize(percentage_disbursement_topic_by_sector = sum_disbursement/sum(sum_disbursement))
```

```{r}
topic_sector_sunburst<- activity_stats_sids %>% 
  group_by(topic, sector) %>% 
  summarize(sum_disbursement = sum(sum_disbursement))
```

```{r}
topic_sector_sunburst_merged <- topic_sector_sunburst %>%
  filter(sector != "") %>%
  mutate(path = paste(sector, topic, sep="-")) %>%
  dplyr::select(path, sum_disbursement)
```

```{r}
topic_sector_sunburst_merged<- subset(topic_sector_sunburst_merged, select= -c(topic))
```


```{r}
p <- sunburst(topic_sector_sunburst_merged, legend=FALSE)
p
```

