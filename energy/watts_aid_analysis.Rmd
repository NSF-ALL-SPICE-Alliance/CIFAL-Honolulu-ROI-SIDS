---
title: "Solar | Aid & Indicators"
author: "Connor Flynn"
date: "9/14/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(plotly)
library(readxl)
library(janitor)
library(sunburstR)
library(htmltools)
library(dplyr)
library(shiny)
library(tseries)
library(astsa)
library(ggpubr)
options(scipen = 99)
```


Import Data from "Monitoring GLobal Aid with Machine Learning"

```{r, include=FALSE, results='hide'}
activity_clusters <- read_csv(here("data/activity_cluster_data.csv"))
```


```{r, include=FALSE, results='hide'}
descriptive_stats <- read_excel(here("data/descriptive_statistics_clusters.xlsx"))
```

Import Data from SIDS Data Platform - *may normalize for population*

```{r}
installed_renewable_per_capita <- read_csv(here("energy/indicator/installed_renewable_electricity_generating_capacity_watts_per_capita.csv"), skip = 1)

### IMmporting data from file path
energy_intensity_level_of_primary_energy <- read_csv(here("energy/indicator/energy_intensity_level_of_primary_energy(mejajoules_per_constant_2017_purchasisn_power_parity_GDP).csv"), skip = 1)

### IMmporting data from file path
Proportion_of_population_with_access_to_electricity <- read_csv(here("energy/indicator/Proportion_of_population_with_access_to_electricity_by_urban%.csv"), skip = 1)

international_fiancial_flows <- read_csv(here("energy/indicator/international_financial_flows.csv"), skip = 1)

```




```{r}
installed_renewable_per_capita[installed_renewable_per_capita == 'No Data'] <- NA

### New code
energy_intensity_level_of_primary_energy[energy_intensity_level_of_primary_energy == 'No Data'] <- NA

### New code
Proportion_of_population_with_access_to_electricity[Proportion_of_population_with_access_to_electricity == 'No Data'] <- NA

### New Code
international_fiancial_flows[international_fiancial_flows == 'No Data'] <- NA

```




```{r}
installed_renewable_per_capita_longer <- installed_renewable_per_capita %>% 
  mutate(across(!Year, as.character)) %>%
  pivot_longer(cols = !Year,
               names_to = "recipient_name",
               values_to = "value") %>% 
  clean_names()
```

```{r}
### Andrews implementation
energy_intensity_level_of_primary_energy <- energy_intensity_level_of_primary_energy %>% 
  mutate(across(!Year, as.character)) %>%
  pivot_longer(cols = !Year,
               names_to = "recipient_name",
               values_to = "value") %>% 
  clean_names()

Proportion_of_population_with_access_to_electricity <- Proportion_of_population_with_access_to_electricity %>% 
  mutate(across(!Year, as.character)) %>%
  pivot_longer(cols = !Year,
               names_to = "recipient_name",
               values_to = "value") %>% 
  clean_names()


international_fiancial_flows <- international_fiancial_flows %>% 
  mutate(across(!Year, as.character)) %>%
  pivot_longer(cols = !Year,
               names_to = "recipient_name",
               values_to = "value") %>% 
  clean_names()
```



Filter and Join Data from "Monitoring Global Aid with Machine Learning"




```{r, include=FALSE, results='hide'}
activity_clusters <- activity_clusters %>% 
  mutate(disbursement = USD_Disbursement * 1000000)
```

```{r, include=FALSE, results='hide'}
sids <- c('Anguilla', 'Antigua and Barbuda', 'Bahrain', 'Barbados', 'Belize', 'Cabo Verde', 'Comoros', 
             'Cook Islands', 'Dominica', 'Dominican Republic', 'Fiji', 'Grenada', 'Guinea-Bissau', 'Guyana', 
             'Haiti', 'Jamaica', 'Kiribati', 'Maldives', 'Marshall Islands', 'Mauritius', 'Micronesia', 
             'Montserrat', 'Nauru', 'Niue', 'Palau', 'Papua New Guinea', 'Saint Kitts and Nevis', 'Saint Lucia', 
             'Saint Vincent and the Grenadines', 'Samoa', 'Sao Tome and Principe', 'Seychelles', 'Solomon Islands', 
             'Suriname', 'Timor-Leste', 'Tokelau', 'Tonga', 'Trinidad and Tobago', 'Turks and Caicos Islands', 
             'Tuvalu', 'Vanuatu')
```

```{r, include=FALSE, results='hide'}
colnames(activity_clusters)[colnames(activity_clusters) == "cluster"] ="Cluster"
```

```{r, include=FALSE, results='hide'}
activity_stats_join<- full_join(activity_clusters, descriptive_stats, by='Cluster')
```

```{r, include=FALSE, results='hide'}
activity_stats_sids<-activity_stats_join %>%
  filter(RecipientName %in% sids)
```

```{r, include=FALSE, results='hide'}
activity_stats_sids <- activity_stats_sids %>% 
  clean_names()
```


Combining
```{r}
activity_stats_sids_energy <- activity_stats_sids %>% 
  filter(sector == "Energy")
```


```{r}
colnames(installed_renewable_per_capita_longer)[colnames(installed_renewable_per_capita_longer) == "value"] ="Renewable_watts_per_capita"
```


```{r}
indicator_installed_renewable_aid <- activity_stats_sids_energy %>%
  left_join(installed_renewable_per_capita_longer, 
            by = c("year", "recipient_name"))
```




```{r}
colnames(energy_intensity_level_of_primary_energy)[colnames(energy_intensity_level_of_primary_energy) == "value"] ="Energy_intensity_level_of_primary_energy_mj_per_gdp"


colnames(Proportion_of_population_with_access_to_electricity)[colnames(Proportion_of_population_with_access_to_electricity) == "value"] ="Proportion_of_population_with_access_to_electricity"

colnames(international_fiancial_flows)[colnames(international_fiancial_flows) == "value"] ="international_financial_flow"
```

```{r}
indicator_installed_renewable_energy_intensity_aid <- indicator_installed_renewable_aid %>%
  left_join(energy_intensity_level_of_primary_energy, 
            by = c("year", "recipient_name"))
```

```{r}

indicator_installed_renewable_energy_intensity_population_access_aid <- indicator_installed_renewable_energy_intensity_aid %>%
  left_join(Proportion_of_population_with_access_to_electricity, 
            by = c("year", "recipient_name"))
```

```{r}

indicator_installed_renewable_energy_intensity_population_access_financial_flows_aid <- indicator_installed_renewable_energy_intensity_population_access_aid %>%
  left_join(international_fiancial_flows, 
            by = c("year", "recipient_name"))
```


```{r}
energy_aid_indicators <- indicator_installed_renewable_energy_intensity_population_access_financial_flows_aid
```


```{r}
energy_aid_indicators <- energy_aid_indicators %>% 
  select(-cluster, -usd_disbursement, -country_code, -incomegroup_name, -matching_purpose_code, -purpose_code, -count_activities)
```


```{r}
energy_aid_indicators$Renewable_watts_per_capita <- as.numeric(energy_aid_indicators$Renewable_watts_per_capita)
```


*Analysis*

```{r}
unique(energy_aid_indicators$topic)
```
```{r}
renewable_watts_relevant_topics <- c("Energy generation, renewable sources - multiple technologies", "Hydro-electric power plants", "Natural gas-fired electric power plants", "Solar energy", "Geothermal energy", "Marine energy", "Wind energy", "Biofuel-fired power plants")
```



```{r}
energy_aid_indicators_renewable_watts_relevant_topics <- energy_aid_indicators %>% 
  filter(topic %in% renewable_watts_relevant_topics)
```

```{r}
energy_aid_indicators_renewable_watts_relevant_topics_grouped <- energy_aid_indicators_renewable_watts_relevant_topics %>% 
  group_by(year, topic) %>% 
  summarise(topic_disbursement = sum(disbursement)) 



  ggplot(data = energy_aid_indicators_renewable_watts_relevant_topics_grouped, aes(x = year, y = topic_disbursement, color = topic)) +
    geom_line() +
    geom_point() +
  theme_minimal()
  
              
```

```{r}
energy_aid_indicators_renewable_watts_relevant_topics_grouped <- energy_aid_indicators_renewable_watts_relevant_topics %>% 
  group_by(recipient_name, year, Renewable_watts_per_capita) %>% 
  summarize(renewable_disbursement = sum(disbursement))
```



By Country Correlation - need to add lags
```{r}


# Calculate correlation between disbursement and Renewable_watts_per_capita for each country
correlations <- by(energy_aid_indicators_renewable_watts_relevant_topics_grouped, energy_aid_indicators_renewable_watts_relevant_topics_grouped$recipient_name, function(sub_data) {
  if (all(!is.na(sub_data$renewable_disbursement)) && all(!is.na(sub_data$Renewable_watts_per_capita))) {
    cor(sub_data$renewable_disbursement, sub_data$Renewable_watts_per_capita)
  } else {
    NA
  }
})

# Print the correlations for each country
print(correlations)



```
```{r}
energy_aid_indicators_renewable_watts_relevant_topics_grouped_country <- energy_aid_indicators_renewable_watts_relevant_topics_grouped %>% 
  filter(recipient_name == "Mauritius")  
  
ggplot(energy_aid_indicators_renewable_watts_relevant_topics_grouped_country, aes(x = year, y = renewable_disbursement)) +
  geom_line()+
    geom_point()

ggplot(energy_aid_indicators_renewable_watts_relevant_topics_grouped_country, aes(x = year, y = Renewable_watts_per_capita)) +
  geom_line()+
    geom_point()
  
```


Average SIDS Renewable watts per capita per year with renewable disbursement (ccf)


Does the most change in Renewable Watts Per Capita mean the most money

```{r}
all_sids_aid_watts <- energy_aid_indicators_renewable_watts_relevant_topics_grouped %>% 
  group_by(year) %>% 
  summarise(sum_aid = sum(renewable_disbursement),
            sum_watts = sum(Renewable_watts_per_capita, na.rm = TRUE))

  
```



```{r}
ggplot(all_sids_aid_watts, aes(x = year, y = sum_aid)) +
  geom_line()+
    geom_point()

ggplot(all_sids_aid_watts, aes(x = year, y = sum_watts)) +
  geom_line()+
    geom_point()
```
```{r}

lm(sum_watts ~ sum_aid, all_sids_aid_watts)

all_sids_aid_watts$year <- as.factor(all_sids_aid_watts$year)
  
watts_aid_plot <- ggplot(all_sids_aid_watts, aes(x = sum_aid, y = sum_watts,  color = year)) +
  geom_point() +
  geom_smooth() +
  theme_minimal()
ggplotly(watts_aid_plot)
```


*Theory may be flawed but lm says $1 million in investment increases renewable energy per capita by 9 watts*



Temporal Lag Analysis with all_sids_aid_watts

```{r}
acf_all_sids_aid_watts <- acf(all_sids_aid_watts, lag.max = 10)
```

```{r}
matrix_all_sids_aid_watts <- as.matrix(all_sids_aid_watts)
```

```{r}
ccf__object <- ccf(all_sids_aid_watts$sum_watts, all_sids_aid_watts$sum_aid, lag.max = 10)
```

```{r}
# aid_ts <- all_sids_aid_watts %>% 
#   select(year, sum_aid) %>% 
#   as.ts()
# 
# watts_ts <- all_sids_aid_watts %>% 
#   select(year, sum_watts) %>% 
#   as.ts()
aid_ts <- ts(all_sids_aid_watts$sum_aid)
watts_ts <- ts(all_sids_aid_watts$sum_watts)


lag2.plot(aid_ts, watts_ts, max.lag = 15)
```

```{r}
energy_aid <- energy_aid_indicators_renewable_watts_relevant_topics_grouped %>% 
  filter(recipient_name == "Mauritius")  %>% 
  drop_na()

aid_ts <- ts(energy_aid$renewable_disbursement)
watts_ts <- ts(energy_aid$Renewable_watts_per_capita)


lag2.plot(aid_ts, watts_ts, max.lag = 8)

```
```{r}
# Create a new dataframe with recipient_name, change in Renewable_watts_per_capita, and sum of renewable_disbursement
# Custom function to calculate the change while ignoring NAs
change_ignore_na <- function(x) {
  non_na_values <- x[!is.na(x)]
  if (length(non_na_values) >= 2) {
    last_value <- tail(non_na_values, 1)
    first_value <- head(non_na_values, 1)
    return(last_value - first_value)
  } else {
    return(NA)
  }
}

new_dataframe <- energy_aid_indicators_renewable_watts_relevant_topics_grouped %>%
  group_by(recipient_name) %>%
  summarise(
    Change_in_Renewable_watts_per_capita = change_ignore_na(Renewable_watts_per_capita),
    Sum_renewable_disbursement = sum(renewable_disbursement, na.rm = TRUE)
  )


```

```{r}
a <- ggplot(new_dataframe, aes(Change_in_Renewable_watts_per_capita, Sum_renewable_disbursement, label = recipient_name)) +
  geom_point() +
  theme_minimal()

ggplotly(a)
```

```{r}


# Create a new dataframe with recipient_name, percentage change in Renewable Watts Per Capita, and sum of renewable_disbursement
percent_dataframe <- energy_aid_indicators_renewable_watts_relevant_topics_grouped %>%
  group_by(recipient_name) %>%
  summarise(
    Percentage_Change_in_Renewable_Watts_Per_Capita = ((last(Renewable_watts_per_capita) - first(Renewable_watts_per_capita)) / first(Renewable_watts_per_capita)) * 100,
    Sum_renewable_disbursement = sum(renewable_disbursement)
  )

# Print the new dataframe
print(percent_dataframe)

```


Group aid disbursements so that aid from previous years is added to current year 

```{r}
energy_aid_indicators_renewable_watts_relevant_topics_grouped
```

```{r}
stacked_watts <- ggplot(energy_aid_indicators_renewable_watts_relevant_topics_grouped, aes(x = year, y = Renewable_watts_per_capita, fill = recipient_name)) +
  geom_area() +
  theme_minimal() 
ggplotly(stacked_watts)

stacked_aid <- ggplot(energy_aid_indicators_renewable_watts_relevant_topics_grouped, aes(x = year, y = renewable_disbursement, fill = recipient_name)) +
  geom_area() +
  theme_minimal() 
ggplotly(stacked_aid)
```



Group aid disbursements 



Un-Normalize by population

```{r}
population <- read_csv(here("data/sids_pop.csv"))

population_longer <- population %>%
  filter(Year >= 2000) %>% 
  mutate_all(~ ifelse(. == "No Data", NA, .)) %>% 
  mutate_all(as.numeric) %>% 
  pivot_longer(cols = !Year, 
               names_to = "recipient_name", 
               values_to = "population",
               values_drop_na = TRUE) %>%  # This ignores NA values
  clean_names()

  #select(-Anguilla, -`Cook Islands`, -Montserrat, -Niue, -Tokelau) %>% 
 

 
```


```{r}
renewable_aid_watts_unstandardized <- full_join(energy_aid_indicators_renewable_watts_relevant_topics_grouped, population_longer, by = c("recipient_name", "year"))
```


```{r}
renewable_aid_watts_unstandardized <- renewable_aid_watts_unstandardized %>% 
  mutate(renewable_watts = Renewable_watts_per_capita * population)
```


```{r}
watts_plot <- ggplot(renewable_aid_watts_unstandardized, aes(x = year, y = renewable_watts, color = recipient_name)) +
  geom_line() +
  theme_minimal()

ggplotly(watts_plot)
```



```{r}
renewable_aid_watts_unstandardized_grouped <- renewable_aid_watts_unstandardized %>%
  group_by(recipient_name) %>%
  summarise(
    Change_in_Renewable_watts = change_ignore_na(renewable_watts),
    Sum_renewable_disbursement = sum(renewable_disbursement, na.rm = TRUE)
  )
```

```{r}
a <- ggplot(renewable_aid_watts_unstandardized_grouped, aes(Change_in_Renewable_watts, Sum_renewable_disbursement, label = recipient_name)) +
  geom_point() +
  theme_minimal()+
  xlim(0,100000000)

ggplotly(a)
```


```{r}
all_sids_aid_watts_unstandardized <- renewable_aid_watts_unstandardized %>% 
  group_by(year) %>% 
  summarise(sum_aid = sum(renewable_disbursement, na.rm = TRUE),
            sum_watts = sum(renewable_watts, na.rm = TRUE)) %>% 
  filter(year < 2020)
```

```{r}
lm(sum_watts ~ sum_aid, data = all_sids_aid_watts_unstandardized)

ggplot(all_sids_aid_watts_unstandardized, aes(x = sum_watts, y = sum_aid, color = year)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue") + 
  stat_cor() +
  theme_minimal()
  

```


```{r}
aid_ts_unstandardized <- ts(all_sids_aid_watts_unstandardized$sum_aid)
watts_ts_unstandardized <- ts(all_sids_aid_watts_unstandardized$sum_watts)


lag2.plot(aid_ts_unstandardized, watts_ts_unstandardized, max.lag = 15)
```







For Andrew:

Are SIDS who get the most funding for coal and oil topics the most stagnant in renewable watts per capita over time

Can we add temporal lag analysis (ccf package/function form video) for 
- All SIDS
- Each SIDS

Energy per person year
